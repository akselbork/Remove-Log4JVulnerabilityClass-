# Remove-Log4JVulnerabilityClass-
Log4J vulnerability Script to remove the "JndiLookup.Class" from JAR, WAR and other Java related files

<h1>SCRIPTS:</h1>
There is two diffent type of PS scripts.
Output examles are add beside the scripts.

<h2>Remove-Log4J_JndiLookupClass-PSv5.ps1 (Outdated)</h2>
This script can only run locally on a computer

<h2>Remove-Log4J_JndiLookupClassRemotely-PSv5.ps1</h2>
This script can run locally or/and against remote computers.<br>
Is now executing in a RunSpace for a default of 10 paralles sessions.



<h1>HELP</h1>
This section below, is the comment based help for "Remove-Log4J_JndiLookupClassRemotely-PSv5.ps1"<br>
<br>
<#<br>
.SYNOPSIS<br>
       CleanUp script for removing vulnerable Java class based on CVE-2021-45105<br>
    .DESCRIPTION<br>
        As the last resorse, the removing of the class file "JndiLookup.class" from the jar file containing it, can be necessary<br>
        This script can find all files with JAR, WAR, EAR, JPI, and HPI extension or a single specified file with the vulnerability<br>
        It can remove the string by unZipping it to a workfolder, and the reZip it back to its orginal location<br>
        You can also choose just to get a list of files that contains the class with removing the class.<br>
        The Script is running it paralle execution mode<br>
       <br>
    .PARAMETER Computername<br>
        A single or collection of systems to perform the query against<br>
     <br>
    .PARAMETER Credential<br>
        Credentials to query remote computers<br>
     <br>
    .PARAMETER ToCSV<br>
        Name of CSV to write the results of the query to<br>
     <br>
    .PARAMETER Throttle<br>
        Number of asynchronous jobs that will run at a time<br>
     <br>
    .PARAMETER ShowProgress<br>
        Displays the progress of the services query<br>
    <br>
    .PARAMETER file<br>
        fullname of a single file to investigate<br>
    <br>
    .PARAMETER JavaClass<br>
        The class name to remove<br>
    <br>
    .PARAMETER WorkFolder<br>
        The folder to where the work on the file is done<br>
        Default: "temp-log4j"<br>
    <br>
    .PARAMETER RootPath<br>
        The drive the workfolder is created on<br>
        Default: "C:""<br>
    <br>    
    .PARAMETER Compressionlevel<br>
        What type of compression should be used<br>
        Default: "Fastest"<br>
    <br>    
    .PARAMETER Out<br>
        To get the result of the cleanup out as an Object<br>
    <br>
    .PARAMETER onlyQuery<br>
        If only interesting in getting the numbers, and fullnames on files vulnerable<br>
    <br>
    .NOTES<br>
        Author:     Aksel Bork<br>
        Created:    2021-12-22<br>
        The RunSpace part is based on the article <br>
    <br>
        Author:     Boe Prox<br>
        Created:    2012-03-14<br>
        link:       https://devblogs.microsoft.com/scripting/expert-commentary-2012-scripting-games-advanced-event-2/<br>
        2021-12-22  1       Creation<br>
        2021-12-22  1.1     Add extra extension to querystring ("*.jar","*.war","*.ear","*.jpi","*.hpi")<br>
        2021-12-22  2       Change to use "RunSpace" for paralle execution<br>
                            Adding "Write-infomation" for showing INPUT data and execution time<br>
       <br>
       <br>
    .EXAMPLE<br>
        Remove-Log4JVulnerabilityClassRemotely -Computername $env:COMPUTERNAME -Verbose -Credential $cred -InformationAction Continue<br>
        Description<br>
        -----------<br>
        Cleanup all files found from the local system, and outputting verbose and information to console<br>
        No output data would for futher processing would be made.<br>
        <br>  
        <br>
    .EXAMPLE<br>
        $output = Remove-Log4JVulnerabilityClassRemotely -Computername fil01  -out -onlyQuery  -Credential $CRED -InformationAction Continue -Verbose   <br>
        $output<br>
        Description<br>
        -----------<br>
        Query all files found on local or remote computer, and outputting verbose and information to console<br>
        Output data is stored in variable and pasted to the console.<br>
        <br>
        <br>
        ####################################################################<br>
        <br>
        [INFO][INPUT][CREDENTIAL]          company\administrator<br>
        [INFO][INPUT][COMPUTERS]           1<br>
        [INFO][INPUT][FILE]                <br>
        [INFO][INPUT][JAVACLASS]           JndiLookup.class<br>
        [INFO][INPUT][WORKFOLDER]          _temp-log4J<br>
        [INFO][INPUT][ROOTPATH]            C:<br>
        [INFO][INPUT][COMPRESSION]         Fastest<br>
        [INFO][INPUT][INCLUDENETWORKSHARE] False<br>
        [INFO][INPUT][WRITE OUTPUT]        True<br>
        [INFO][INPUT][ONLYQUERY]           True<br>
        [INFO][INPUT][VERBOSE]             Continue<br>
        [INFO][INPUT][CREDENTIAL]          company\administrator<br>
        <br>
        ####################################################################<br>
        <br>
        VERBOSE: 09:32:32.3518 [BEGIN  ] Creating runspace pool and session states<br>
        VERBOSE: 09:32:32.3518 [BEGIN  ] Creating empty collection to hold runspace jobs<br>
        VERBOSE: 09:32:32.3674 [PROCESS] Validating that current user is Administrator or supplied alternate credentials<br>
        VERBOSE: 09:32:32.3719 [PROCESS] Adding fil01 collection<br>
        VERBOSE: 09:32:32.3719 [PROCESS] Checking status of runspace jobs<br>
        VERBOSE: 09:32:32.3835 [PROCESS] Finish processing the remaining runspace jobs: <br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01] Starting<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][FILE]<br>                
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][FILE EXTENSION]      *.jar, *.war, *.ear, *.jpi, *.hpi<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][JAVACLASS]           JndiLookup.class<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][WORKFOLDER]          _temp-log4J<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][ROOTPATH]            C:<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][COMPRESSION]         Fastest<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][INCLUDENETWORKSHARE] False<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][WRITE OUTPUT]        True<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][ONLYQUERY]           True<br>
        VERBOSE: 09:32:33.3281 [BEGIN  ] [FIL01][INPUT][VERBOSE]             True<br>
        VERBOSE: 09:32:33.3437 [BEGIN  ] [FIL01][QUERING] Looking on [local] drives<br>
        VERBOSE: 09:32:33.6562 [BEGIN  ] [FIL01][QUERING] Getting [local] drives<br>
        VERBOSE: 09:32:33.6562 [BEGIN  ] [FIL01][QUERING][FILTERING] no smbmapped drives exits.. no filtering nessesary<br>
        VERBOSE: 09:32:33.7031 [BEGIN  ] [FIL01][QUERING][DRIVE] C:\<br>
        VERBOSE: 09:33:26.5313 [BEGIN  ] [FIL01][QUERING][DRIVE] S:\<br>
        VERBOSE: 09:33:26.8750 [BEGIN  ] [FIL01][QUERING] files found [3]<br>
        VERBOSE: 09:33:26.8906 [PROCESS] [FIL01] Status [UNCLEANED]<br>
        VERBOSE: 09:33:26.8906 [END    ] [FIL01]  Ending <br>
        VERBOSE: 09:33:26.9657 [PROCESS] Closing the runspace pool<br>
        VERBOSE: 09:33:26.9814 [PROCESS] Displaying Report<br>
        ####################################################################<br>
        [INFO][STARTTIME] 12/23/2021 09:32:32<br>
        [INFO][ENDTIME]   12/23/2021 09:33:26<br>
        [INFO][RUNTIME]   00d:00h:00m:54s<br>
        ####################################################################<br>
        <br>
        Cleaned      : False<br>
        FullName     : C:\_FILES\PAD.JavaBridge-2.jar | S:\Data\FILES\PAD.JavaBridge-2.jar | S:\Share\FILES\PAD.JavaBridge-2.jar<br>
        StartDate    : 12/23/2021 9:24:24 AM<br>
        IpAddress    : 10.0.2.201 | 10.0.0.201<br>
        Action       : onlyQeury<br>
        ComputerName : FIL01<br>
        QueryDate    : 12/23/2021 9:25:18 AM<br>
        <br>
        <br>
    .EXAMPLE<br>
        $output = Remove-Log4JVulnerabilityClassRemotely -Computername fil01  -out  -Credential $CRED -InformationAction Continue -Verbose<br>
        $output<br>
        <br>
        Description<br>
        -----------<br>
        Query all files found on alocal or remote computer, and outputting verbose and information to console<br>
        If string is found in a file, it is "unZipped" and string remove to be "Zipped" again<br>
        Output data is stored in variable and pasted to the console.<br>
        VERBOSE: 10:14:24.0324 [BEGIN  ] Performing inital Administrator check<br>
        VERBOSE: 10:14:24.0324 [BEGIN  ] Building hash table for ScriptBlock Parameters<br>
        [INFO] Starting Remove-Log4JVulnerabilityClassRemotely<br>
        ####################################################################<br>
        <br>
        [INFO][INPUT][CREDENTIAL]          company\administrator<br>
        [INFO][INPUT][COMPUTERS]           1<br>
        [INFO][INPUT][FILE]                <br>
        [INFO][INPUT][JAVACLASS]           JndiLookup.class<br>
        [INFO][INPUT][WORKFOLDER]          _temp-log4J<br>
        [INFO][INPUT][ROOTPATH]            C:<br>
        [INFO][INPUT][COMPRESSION]         Fastest<br>
        [INFO][INPUT][INCLUDENETWORKSHARE] False<br>
        [INFO][INPUT][WRITE OUTPUT]        True<br>
        [INFO][INPUT][ONLYQUERY]           False<br>
        [INFO][INPUT][VERBOSE]             Continue<br>
        [INFO][INPUT][THROTTLE]            10<br>
        [INFO][INPUT][TOCSV]               <br>
        [INFO][INPUT][SHOWPROGRESS]        False<br>
        <br>
        ####################################################################<br>
        <br>
        VERBOSE: 10:14:24.0641 [BEGIN  ] Creating runspace pool and session states<br>
        VERBOSE: 10:14:24.0908 [BEGIN  ] Creating empty collection to hold runspace jobs<br>
        VERBOSE: 10:14:24.0958 [PROCESS] Validating that current user is Administrator or supplied alternate credentials<br>
        VERBOSE: 10:14:24.0958 [PROCESS] Adding fil01 collection<br>
        VERBOSE: 10:14:24.0958 [PROCESS] Checking status of runspace jobs<br>
        VERBOSE: 10:14:24.1114 [PROCESS] Finish processing the remaining runspace jobs: <br>
        VERBOSE: 10:14:25.0834 [BEGIN  ] [FIL01] Starting<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][FILE]<br>                
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][FILE EXTENSION]      *.jar, *.war, *.ear, *.jpi, *.hpi<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][JAVACLASS]           JndiLookup.class<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][WORKFOLDER]          _temp-log4J<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][ROOTPATH]            C:<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][COMPRESSION]         Fastest<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][INCLUDENETWORKSHARE] False<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][WRITE OUTPUT]        True<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][ONLYQUERY]           False<br>
        VERBOSE: 10:14:25.0991 [BEGIN  ] [FIL01][INPUT][VERBOSE]             True<br>
        VERBOSE: 10:14:25.1147 [BEGIN  ] [FIL01][QUERING] Looking on [local] drives<br>
        VERBOSE: 10:14:25.4272 [BEGIN  ] [FIL01][QUERING] Getting [local] drives<br>
        VERBOSE: 10:14:25.4428 [BEGIN  ] [FIL01][QUERING][FILTERING] no smbmapped drives exits.. no filtering nessesary<br>
        VERBOSE: 10:14:25.4897 [BEGIN  ] [FIL01][QUERING][DRIVE] C:\<br>
        VERBOSE: 10:15:18.3959 [BEGIN  ] [FIL01][QUERING][DRIVE] S:\<br>
        VERBOSE: 10:15:18.7553 [BEGIN  ] [FIL01][QUERING] files found [1]<br>
        VERBOSE: 10:15:18.7553 [PROCESS] [FIL01][DIRECTORY] creating work folder [C:\_temp-log4J]<br>
        VERBOSE: 10:15:18.7553 [PROCESS] [FIL01][DIRECTORY] Creating folder [C:\_temp-log4J\ZIP]<br>
        VERBOSE: 10:15:18.7553 [PROCESS] [FIL01][FILENAME] C:\_FILES\PAD.JavaBridge.jar<br>
        VERBOSE: 10:15:18.7709 [PROCESS] [FIL01][COPY/RENAME] file [C:\_FILES\PAD.JavaBridge.jar] to [C:\_temp-log4J\PAD.JavaBridge.zip]<br>
        VERBOSE: 10:15:18.7709 [PROCESS] [FIL01][EXPAND] file [C:\_temp-log4J\PAD.JavaBridge.zip] to folder [C:\_temp-log4J\ZIP]<br>
        VERBOSE: 10:15:22.3803 [PROCESS] [FIL01][REMOVING CLASS][C:\_temp-log4J\ZIP\org\apache\logging\log4j\core\lookup\JndiLookup.class] class [JndiLookup.class]<br>
        VERBOSE: 10:15:22.3803 [PROCESS] [FIL01][COMPRESS] file [C:\_temp-log4J\ZIP] to [C:\_temp-log4J\PAD.JavaBridge.zip]<br>
        VERBOSE: 10:15:25.3334 [PROCESS] [FIL01][COPY/RENAME] file [C:\_temp-log4J\PAD.JavaBridge.zip] to [C:\_FILES\PAD.JavaBridge.jar]<br>
        VERBOSE: 10:15:25.3334 [PROCESS] [FIL01][CLEANUP] Deleting folder [C:\_temp-log4J]<br>
        VERBOSE: 10:15:25.5834 [PROCESS] [FIL01][CLEANUP] Status cleanup [Successful]<br>
        VERBOSE: 10:15:25.6303 [PROCESS] [FIL01][FILENAME][C:\_FILES\PAD.JavaBridge.jar] Status [CLEANED]<br>
        VERBOSE: 10:15:25.6459 [END    ] [FIL01]  Ending <br>
        VERBOSE: 10:15:25.7470 [PROCESS] Closing the runspace pool<br>
        VERBOSE: 10:15:25.7470 [PROCESS] Displaying Report<br>
        <br>
        ####################################################################<br>
        [INFO][STARTTIME] 12/23/2021 10:14:24<br>
        [INFO][ENDTIME]   12/23/2021 10:15:25<br>
        [INFO][RUNTIME]   00d:00h:01m:01s<br>
        ComputerName : FIL01<br>
        StartDate    : 12/23/2021 10:14:24 AM<br>
        Action       : Clean<br>
        FullName     : C:\_FILES\PAD.JavaBridge.jar<br>
        Cleaned      : True<br>
        FileName     : PAD.JavaBridge.jar<br>
        IpAddress    : 10.0.2.201 | 10.0.0.201<br>
        QueryDate    : 12/23/2021 10:15:25 AM<br>
        <br>
#><br>
